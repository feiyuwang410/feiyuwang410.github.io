<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>杭州公寓租售比数据分析</title>
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入 ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#FF7D00',
            neutral: {
              100: '#F5F7FA',
              200: '#E4E7ED',
              300: '#C0C4CC',
              400: '#909399',
              500: '#606266',
              600: '#303133',
              700: '#1E1E1E',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
    }
  </style>
</head>
<body class="font-inter bg-neutral-100 text-neutral-600 min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-line-chart text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-neutral-700">杭州公寓租售比数据分析</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="refresh-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all-300 flex items-center">
          <i class="fa fa-refresh mr-2"></i>刷新数据
        </button>
      </div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl p-6 card-shadow hover:shadow-lg transition-all-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-neutral-500 text-sm">平均年化回报率</p>
            <h3 id="avg-return" class="text-2xl font-bold text-primary mt-1">--</h3>
          </div>
          <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
            <i class="fa fa-percent text-primary text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 card-shadow hover:shadow-lg transition-all-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-neutral-500 text-sm">公寓总数</p>
            <h3 id="total-apartments" class="text-2xl font-bold text-primary mt-1">--</h3>
          </div>
          <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
            <i class="fa fa-building text-primary text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 card-shadow hover:shadow-lg transition-all-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-neutral-500 text-sm">数据更新时间</p>
            <h3 id="update-time" class="text-2xl font-bold text-primary mt-1">--</h3>
          </div>
          <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
            <i class="fa fa-calendar text-primary text-xl"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 图表区域 -->
    <div class="bg-white rounded-xl p-6 card-shadow mb-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-neutral-700">杭州公寓年化回报率排行</h2>
        <div class="flex items-center space-x-4">
          <div class="relative">
            <select id="sort-select" class="appearance-none bg-neutral-100 border border-neutral-200 rounded-lg py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-primary/30">
              <option value="asc">年化回报(低到高)</option>
              <option value="desc" selected>年化回报(高到低)</option>
              <option value="name">按名称排序</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-neutral-400">
              <i class="fa fa-chevron-down text-xs"></i>
            </div>
          </div>
          <div class="relative">
            <select id="filter-select" class="appearance-none bg-neutral-100 border border-neutral-200 rounded-lg py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-primary/30">
              <option value="all">全部区域</option>
              <option value="西湖区">西湖区</option>
              <option value="余杭区">余杭区</option>
              <option value="拱墅区">拱墅区</option>
              <option value="上城区">上城区</option>
              <option value="滨江区">滨江区</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-neutral-400">
              <i class="fa fa-chevron-down text-xs"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="w-full h-[500px]">
        <div id="main-chart" class="w-full h-full"></div>
      </div>
    </div>
    
    <!-- 数据表格 -->
    <div class="bg-white rounded-xl p-6 card-shadow">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-neutral-700">详细数据</h2>
        <div class="relative">
          <input type="text" id="search-input" placeholder="搜索公寓..." class="bg-neutral-100 border border-neutral-200 rounded-lg py-2 pl-10 pr-4 w-64 focus:outline-none focus:ring-2 focus:ring-primary/30">
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
            <i class="fa fa-search text-neutral-400"></i>
          </div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-neutral-200">
          <thead>
            <tr>
              <th class="px-6 py-3 bg-neutral-100 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">排名</th>
              <th class="px-6 py-3 bg-neutral-100 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">公寓名称</th>
              <th class="px-6 py-3 bg-neutral-100 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">区域</th>
              <th class="px-6 py-3 bg-neutral-100 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">平均房价(元/㎡)</th>
              <th class="px-6 py-3 bg-neutral-100 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">平均租金(元/月)</th>
              <th class="px-6 py-3 bg-neutral-100 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">10个月租金(元)</th>
              <th class="px-6 py-3 bg-neutral-100 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">年化回报率(%)</th>
            </tr>
          </thead>
          <tbody id="data-table-body" class="bg-white divide-y divide-neutral-200">
            <!-- 数据将通过JavaScript动态填充 -->
          </tbody>
        </table>
      </div>
      <div id="no-data-message" class="hidden py-8 text-center text-neutral-500">
        <i class="fa fa-search-minus text-3xl mb-2"></i>
        <p>未找到匹配的数据</p>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-neutral-200 py-6">
    <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
      <p>© 2025 杭州公寓租售比数据分析平台 | 数据仅供参考</p>
    </div>
  </footer>

  <!-- 加载中遮罩层 -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 hidden">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
      <p class="text-neutral-700 font-medium">加载数据中...</p>
    </div>
  </div>

  <script>
    // 替换为你的 GitHub CSV 原始 URL
    const dataUrl = '杭州公寓租售比.csv';
    
    // 全局变量存储数据
    let originalData = [];
    let filteredData = [];
    
    // 加载中状态
    const showLoading = () => {
      document.getElementById('loading-overlay').classList.remove('hidden');
    };
    
    const hideLoading = () => {
      document.getElementById('loading-overlay').classList.add('hidden');
    };
    
    // 获取当前日期时间
    const getCurrentDateTime = () => {
      const now = new Date();
      return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    };
    
    // 格式化数字为千分位
    const formatNumber = (num) => {
      if (isNaN(num)) return '--';
      return num.toLocaleString('zh-CN');
    };
    
    // 格式化百分比
    const formatPercentage = (num) => {
      if (isNaN(num)) return '--';
      return num.toFixed(2) + '%';
    };
    
    // 加载数据
    const loadData = async () => {
      showLoading();
      
      try {
        const response = await fetch(dataUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.text();
        processData(data);
        updateStats();
        renderChart();
        renderTable();
        
        // 更新时间戳
        document.getElementById('update-time').textContent = getCurrentDateTime();
        
      } catch (error) {
        console.error('Error loading data:', error);
        alert('加载数据失败，请稍后重试');
      } finally {
        hideLoading();
      }
    };
    
    // 处理CSV数据
    const processData = (csvData) => {
      const rows = csvData.split('\n').filter(row => row.trim() !== '');
      const headers = rows[0].split(',');
      
      originalData = [];
      
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i].split(',');
        if (row.length < headers.length) continue; // 跳过不完整的行
        
        // 提取数据并转换为适当的类型
        const apartment = {
          name: row[0].trim(),
          district: row[1].trim(),
          pricePerSqm: parseFloat(row[2]),
          rentPerMonth: parseFloat(row[3]),
          tenMonthRent: parseFloat(row[4]),
          annualReturn: parseFloat(row[5]),
        };
        
        // 仅添加有效数据
        if (!isNaN(apartment.annualReturn)) {
          originalData.push(apartment);
        }
      }
      
      // 默认按年化回报率降序排序
      sortData('desc');
      filteredData = [...originalData];
    };
    
    // 排序数据
    const sortData = (sortType) => {
      if (sortType === 'asc') {
        originalData.sort((a, b) => a.annualReturn - b.annualReturn);
      } else if (sortType === 'desc') {
        originalData.sort((a, b) => b.annualReturn - a.annualReturn);
      } else if (sortType === 'name') {
        originalData.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
      }
    };
    
    // 筛选数据
    const filterData = (district) => {
      if (district === 'all') {
        filteredData = [...originalData];
      } else {
        filteredData = originalData.filter(item => item.district === district);
      }
      renderChart();
      renderTable();
    };
    
    // 更新统计信息
    const updateStats = () => {
      // 计算平均年化回报率
      const totalReturn = filteredData.reduce((sum, item) => sum + item.annualReturn, 0);
      const avgReturn = totalReturn / filteredData.length;
      
      // 更新统计卡片
      document.getElementById('avg-return').textContent = formatPercentage(avgReturn);
      document.getElementById('total-apartments').textContent = formatNumber(filteredData.length);
    };
    
    // 渲染图表
    const renderChart = () => {
      const chartDom = document.getElementById('main-chart');
      const myChart = echarts.init(chartDom);
      
      // 准备图表数据
      const names = filteredData.map(item => item.name);
      const returns = filteredData.map(item => item.annualReturn);
      
      // 图表配置
      const option = {
        backgroundColor: 'transparent',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          borderColor: '#E4E7ED',
          borderWidth: 1,
          textStyle: {
            color: '#303133',
            fontFamily: 'Inter'
          },
          formatter: (params) => {
            const param = params[0];
            const dataIndex = param.dataIndex;
            const apartment = filteredData[dataIndex];
            
            return `
              <div class="font-bold mb-1">${apartment.name}</div>
              <div class="text-sm">区域: ${apartment.district}</div>
              <div class="text-sm">年化回报率: ${formatPercentage(apartment.annualReturn)}</div>
              <div class="text-sm">平均房价: ${formatNumber(apartment.pricePerSqm)} 元/㎡</div>
              <div class="text-sm">平均租金: ${formatNumber(apartment.rentPerMonth)} 元/月</div>
              <div class="text-sm">10个月租金: ${formatNumber(apartment.tenMonthRent)} 元</div>
            `;
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          top: '5%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: names,
          axisLabel: {
            interval: 0,
            rotate: 45,
            margin: 10,
            color: '#606266',
            fontSize: 11,
            fontFamily: 'Inter',
            formatter: (value) => {
              // 如果名称太长，截断显示
              if (value.length > 8) {
                return value.substring(0, 8) + '...';
              }
              return value;
            }
          },
          axisTick: {
            show: false
          },
          axisLine: {
            lineStyle: {
              color: '#E4E7ED'
            }
          }
        },
        yAxis: {
          type: 'value',
          name: '年化回报率(%)',
          nameLocation: 'end',
          nameGap: 20,
          nameTextStyle: {
            color: '#606266',
            fontSize: 12,
            fontFamily: 'Inter'
          },
          axisLabel: {
            color: '#606266',
            fontSize: 12,
            fontFamily: 'Inter',
            formatter: (value) => value.toFixed(1)
          },
          axisTick: {
            show: false
          },
          axisLine: {
            show: false
          },
          splitLine: {
            lineStyle: {
              color: '#E4E7ED'
            }
          }
        },
        series: [{
          name: '年化回报率',
          type: 'bar',
          data: returns,
          itemStyle: {
            color: {
              type: 'linear',
              x: 0, y: 0, x2: 0, y2: 1,
              colorStops: [{
                offset: 0, color: '#36BFFA' // 0% 处的颜色
              }, {
                offset: 1, color: '#165DFF' // 100% 处的颜色
              }],
              global: false // 缺省为 false
            },
            borderRadius: [4, 4, 0, 0]
          },
          barWidth: '60%',
          label: {
            show: true,
            position: 'top',
            color: '#303133',
            fontSize: 12,
            fontFamily: 'Inter',
            formatter: (params) => params.value.toFixed(2) + '%'
          }
        }]
      };
      
      // 使用配置项显示图表
      myChart.setOption(option);
      
      // 监听窗口大小变化，调整图表
      window.addEventListener('resize', () => {
        myChart.resize();
      });
    };
    
    // 渲染表格
    const renderTable = () => {
      const tableBody = document.getElementById('data-table-body');
      const noDataMessage = document.getElementById('no-data-message');
      
      // 清空表格
      tableBody.innerHTML = '';
      
      // 检查是否有数据
      if (filteredData.length === 0) {
        noDataMessage.classList.remove('hidden');
        return;
      }
      
      // 隐藏无数据消息
      noDataMessage.classList.add('hidden');
      
      // 填充表格
      filteredData.forEach((apartment, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white hover:bg-neutral-50 transition-all-300' : 'bg-neutral-50 hover:bg-neutral-100 transition-all-300';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-neutral-700">${index + 1}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600 font-medium">${apartment.name}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">${apartment.district}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">${formatNumber(apartment.pricePerSqm)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">${formatNumber(apartment.rentPerMonth)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">${formatNumber(apartment.tenMonthRent)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${apartment.annualReturn > 3 ? 'text-green-600' : 'text-neutral-600'}">${formatPercentage(apartment.annualReturn)}</td>
        `;
        
        tableBody.appendChild(row);
      });
    };
    
    // 搜索功能
    const searchData = (keyword) => {
      if (!keyword.trim()) {
        filteredData = [...originalData];
      } else {
        const lowerKeyword = keyword.toLowerCase();
        filteredData = originalData.filter(item => 
          item.name.toLowerCase().includes(lowerKeyword) || 
          item.district.toLowerCase().includes(lowerKeyword)
        );
      }
      renderTable();
    };
    
    // 事件监听
    document.addEventListener('DOMContentLoaded', () => {
      // 加载数据
      loadData();
      
      // 排序选择
      document.getElementById('sort-select').addEventListener('change', (e) => {
        sortData(e.target.value);
        filterData(document.getElementById('filter-select').value);
        updateStats();
      });
      
      // 筛选选择
      document.getElementById('filter-select').addEventListener('change', (e) => {
        filterData(e.target.value);
        updateStats();
      });
      
      // 搜索输入
      document.getElementById('search-input').addEventListener('input', (e) => {
        searchData(e.target.value);
      });
      
      // 刷新按钮
      document.getElementById('refresh-btn').addEventListener('click', () => {
        loadData();
      });
    });
  </script>
</body>
</html>
